<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="language" content="en"/>
    <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css" />
    <script type="text/javascript" src="js/jquery.min.js"></script>
    <script type="text/javascript" src="js/bootstrap.min.js"></script>
    <script type="text/javascript" src="game.js"></script>
    <title>demo game</title>
    <script type="text/javascript">
        $(function () {
            w = h = 52;//416/52=8
            var chat = $("#chat"), canvasdiv = $("#canvasdiv"), canvas = $("#canvas");

            function resize() {
                $("#rightdiv").css('height', $(window).height() - 70);
                chat.css('height', $(window).height() - $("#divinput").height() - $("#minimap").height() - 70);
                canvasdiv.css('width', $(window).width() - 350);
                canvasdiv.css('height', $(window).height() - 70);
                cellsize = Math.min(Math.floor(canvasdiv.height() / h), Math.floor(canvasdiv.width() / w));
                canvas.attr('width', w * cellsize);
                canvas.attr('height', h * cellsize);
                padding = (canvasdiv.width() > canvas.width()) ? (canvasdiv.width() - canvas.width()) / 2 : 0;
                canvasdiv.css('paddingLeft', padding);
                canvasdiv.css('width', canvasdiv.width() - padding);
            }

            resize();

            $(window).resize(function() {
                resize();
            });


            //h = 50;//Math.floor(canvasdiv.height() / cellsize);

            ctx = canvas[0].getContext('2d');
            ctx.font = "12px Arial";

            minimap = $("#minimap")[0].getContext('2d');

            tankmodel = {
                up: document.getElementById('tank1up'),
                down: document.getElementById('tank1down'),
                left: document.getElementById('tank1left'),
                right: document.getElementById('tank1right'),
                up1: document.getElementById('tank1up1'),
                down1: document.getElementById('tank1down1'),
                left1: document.getElementById('tank1left1'),
                right1: document.getElementById('tank1right1')
            }

            window.addEventListener("keydown", keyDown, false);
            window.addEventListener("keyup", keyUp, false);

            function mainLoop(tank) {
                if (!paused) {
                    applyKeys(tank);
                }
                setTimeout(function() {mainLoop(tank)}, 1000 / 10);
            }

            function wsStart() {
                ws = new WebSocket("ws://127.0.0.1:8002/");
                ws.onopen = function () {
                    chat.append("<p>Система: соединение открыто. Чтобы начать играть введите имя, под которым вы будете отображаться. В имени можно использовать английские буквы и цифры. Имя не должно превышать 10 символов.</p>");
                    chat.scrollTop($('#chat')[0].scrollHeight);
                    paused = true;
                    mainLoop({w: w, h: h});
                };
                ws.onclose = function () {
                    chat.append("<p>система: соединение закрыто, пытаюсь переподключиться</p>");
                    chat.scrollTop($('#chat')[0].scrollHeight);
                    paused = true;
                    setTimeout(wsStart, 1000);
                };
                ws.onmessage = function (evt) {
                    var pack = JSON.parse(evt.data);
                    if (pack.cmd == 'message') {
                        chat.append("<p>"+pack.data+"</p>");
                        chat.scrollTop($('#chat')[0].scrollHeight);
                    } else if (pack.cmd == 'tanks') {
                        tanks = pack.data;
                        //chat.append("<p>" + tanks[0].x + "," + tanks[0].y + "</p>");
                        chat.scrollTop($('#chat')[0].scrollHeight);
                        //console.log(tanks[0].x, tanks[0].y, tanks[0].w, tanks[0].h)
                        draw_minimap(tanks[0]);
                        canvas.css('backgroundPosition', -tanks[0].x * cellsize + 'px -' + tanks[0].y * cellsize + 'px');

                        draw();

                        if (paused) {
                            paused = false;
                        }
                    }
                };
            }

            wsStart();

            $('#input').focus();
        });

    </script>
</head>
<body style="min-width: 640px;height: 100%; overflow: hidden;">
<div id="canvasdiv" style="float: left;margin:10px;" class="well">
    <canvas id='canvas' style="border: 1pt inset #000000;background: url(images/SmudgedDirt.png)" tabindex="1">Canvas here</canvas>
</div>

<div id="rightdiv" style="width: 220px; float:left;margin:10px;" class="well">
    <img id="tank1up" src="images/textures/tank1-up-s1.png">
    <img id="tank1down" src="images/textures/tank1-down-s1.png">
    <img id="tank1left" src="images/textures/tank1-left-s1.png">
    <img id="tank1right" src="images/textures/tank1-right-s1.png">
    <img id="tank1up1" src="images/textures/tank1-up-s2.png">
    <img id="tank1down1" src="images/textures/tank1-down-s2.png">
    <img id="tank1left1" src="images/textures/tank1-left-s2.png">
    <img id="tank1right1" src="images/textures/tank1-right-s2.png">
    <canvas id='minimap' width="200" height="200" style="border: 1pt inset #000000;background: url(images/SmudgedDirt.png)" tabindex="1">Canvas here</canvas>
    <div id='chat' style="overflow: auto">
        <p>Система: пожалуйста подождите, идёт соединение с сервером.</p>
    </div>
    <div id="divinput" style="margin-left: -10px;margin-top: 10px;">
        <form onsubmit="ws.send($('input').val()); $('input').val(''); return false; ">
        <input id="input" type="text" class="form-control" placeholder="Text input" style="width: 100%;" maxlength="140" autocomplete="off">
        </form>
    </div>
</div>
</body>
</html>